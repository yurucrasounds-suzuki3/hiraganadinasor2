<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>„Éê„Éà„É´</title>

<style>
  body {
    background: linear-gradient(#ffe9b3 0%, #fff6e0 40%, #f2d39a 100%);
    font-family: "Kosugi Maru", sans-serif;
    margin: 0;
    padding-top: 20px;
    text-align: center;
  }

  #backBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    background: #4c8f3a;
    color: white;
    padding: 10px 18px;
    border-radius: 20px;
    text-decoration: none;
    z-index: 10;
  }

  h2 {
    color:#4c8f3a;
    margin-bottom: 10px;
  }

  .battle-wrapper {
    position: relative;
    width: 100%;
    max-width: 650px;
    margin: 0 auto;
  }

  .battle-area {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 10px auto;
    width: 90%;
  }

  .char {
    width: 40%;
  }

  .char img {
    width: 100%;
    max-width: 180px;
  }

  .ground {
    width: 80%;
    height: 20px;
    background: rgba(0,0,0,0.08);
    border-radius: 50%;
    margin: 0 auto 5px;
  }

  .hp-bar {
    width: 80%;
    height: 14px;
    background: #ccc;
    border-radius: 10px;
    margin: 4px auto 5px;
    overflow: hidden;
  }
  .hp-inner {
    height: 100%;
    background: #4c8f3a;
    transition: width 0.3s;
  }

  .char-name {
    font-size: 18px;
    margin-top: 2px;
  }

  #hitEffect {
    position: absolute;
    top: 50%;
    left: 50%;
    font-size: 52px;
    transform: translate(-50%, -50%) scale(0.3);
    opacity: 0;
    pointer-events: none;
  }

  #hitEffect.show {
    animation: boom 0.35s ease-out;
  }

  @keyframes boom {
    0% {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.2) rotate(-10deg);
    }
    40% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.1) rotate(8deg);
    }
    100% {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.4) rotate(0deg);
    }
  }

  #attackBtn {
    margin-top: 20px;
    padding: 20px 40px;
    background: #ff7f50;
    color: #fff;
    font-size: 28px;
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  #attackBtn:active {
    transform: scale(0.95);
  }

  #log {
    background: #fff;
    width: 90%;
    max-width: 360px;
    margin: 20px auto;
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    height: 150px;
    overflow-y: auto;
    text-align: left;
  }

  #popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.6);
    background: white;
    padding: 25px 35px;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 24px;
    color: #4c8f3a;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    z-index: 50;
  }
  #popup.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
</style>

</head>

<body>

<a id="backBtn" href="index.html">‚Üê „Éõ„Éº„É†„Å∏</a>

<h2>„Éê„Éà„É´ÔºÅ</h2>

<div class="battle-wrapper">
  <div id="hitEffect">üí•</div>

  <div class="battle-area">

    <div class="char" id="playerArea">
      <div class="ground"></div>
      <img id="playerImg">
      <div class="hp-bar"><div class="hp-inner" id="playerHp"></div></div>
      <div id="playerName" class="char-name"></div>
    </div>

    <div class="char" id="enemyArea">
      <div class="ground"></div>
      <img id="enemyImg">
      <div class="hp-bar"><div class="hp-inner" id="enemyHp"></div></div>
      <div id="enemyName" class="char-name"></div>
    </div>

  </div>
</div>

<button id="attackBtn" disabled>„Çà„Éº„ÅÑ‚Ä¶</button>

<div id="log"></div>
<div id="popup"></div>

<script>
const WIN_TAPS = 10;

/* „Ç≠„É£„É©„Éá„Éº„Çø */
const allChars = [
  { id:"tira", name:"„ÉÜ„Ç£„É©„Éé„Çµ„Ç¶„É´„Çπ", rare:5, img:"images/tira.png" },
  { id:"tori", name:"„Éà„É™„Ç±„É©„Éà„Éó„Çπ", rare:4, img:"images/tori.png" },
  { id:"ste", name:"„Çπ„ÉÜ„Ç¥„Çµ„Ç¶„É´„Çπ", rare:3, img:"images/ste.png" },
  { id:"bra", name:"„Éñ„É©„Ç≠„Ç™„Çµ„Ç¶„É´„Çπ", rare:3, img:"images/bra.png" },
  { id:"pte", name:"„Éó„ÉÜ„É©„Éé„Éâ„É≥", rare:2, img:"images/pte.png" },
  { id:"spi", name:"„Çπ„Éî„Éé„Çµ„Ç¶„É´„Çπ", rare:5, img:"images/spi.png" },
  { id:"an",  name:"„Ç¢„É≥„Ç≠„É≠„Çµ„Ç¶„É´„Çπ", rare:2, img:"images/an.png" },
  { id:"para", name:"„Éë„É©„Çµ„Ç¶„É≠„É≠„Éï„Çπ", rare:4, img:"images/para.png" },
  { id:"igu",  name:"„Ç§„Ç∞„Ç¢„Éé„Éâ„É≥", rare:2, img:"images/igu.png" },
  { id:"vero", name:"„É¥„Çß„É≠„Ç≠„É©„Éó„Éà„É´", rare:4, img:"images/vero.png" },

  { id:"tako", name:"„Çø„Ç≥", rare:2, img:"images/tako.png" },
  { id:"same", name:"„Çµ„É°", rare:4, img:"images/same.png" },
  { id:"iruka", name:"„Ç§„É´„Ç´", rare:3, img:"images/iruka.png" },
  { id:"kumanomi", name:"„Ç´„ÇØ„É¨„ÇØ„Éû„Éé„Éü", rare:2, img:"images/kumanomi.png" },
  { id:"kurage", name:"„ÇØ„É©„Ç≤", rare:1, img:"images/kurage.png" },
  { id:"manta", name:"„Éû„É≥„Çø", rare:3, img:"images/manta.png" },
  { id:"hitode", name:"„Éí„Éà„Éá", rare:1, img:"images/hitode.png" },
  { id:"secret", name:"„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà", rare:5, img:"images/secret.png" },
  { id:"ika", name:"„Ç§„Ç´", rare:2, img:"images/ika.png" },
  { id:"rakko", name:"„É©„ÉÉ„Ç≥", rare:3, img:"images/rakko.png" },
  { id:"kame", name:"„Ç´„É°", rare:3, img:"images/kame.png" },

  { id:"tyo", name:"Ëù∂„ÄÖ", rare:1, img:"images/tyo.png" },
  { id:"kabu", name:"„Ç´„Éñ„Éà„É†„Ç∑", rare:4, img:"images/kabu.png" }
];

let owned = JSON.parse(localStorage.getItem("owned") || "[]");
if (owned.length === 0) owned = ["tira"];

const playerChar = allChars.find(c => c.id === owned[Math.floor(Math.random()*owned.length)]);

const enemyChar = {
  id: "oni",
  name: "„ÅÇ„Åã„Åä„Å´",
  img: "images/oni.png"
};

let playerHP = 100;
let enemyHP  = 100;

function updateHp(){
  document.getElementById("playerHp").style.width = playerHP + "%";
  document.getElementById("enemyHp").style.width  = enemyHP + "%";
}

document.getElementById("playerImg").src = playerChar.img;
document.getElementById("playerName").textContent = playerChar.name;
document.getElementById("enemyImg").src = enemyChar.img;
document.getElementById("enemyName").textContent = enemyChar.name;
updateHp();

/* „É≠„Ç∞ */
function log(t){
  const box = document.getElementById("log");
  box.innerHTML += t + "<br>";
  box.scrollTop = box.scrollHeight;
}

/* „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
function showPopup(t){
  const p = document.getElementById("popup");
  p.textContent = t;
  p.classList.add("show");
  setTimeout(()=>p.classList.remove("show"),1500);
}

function showHitEffect() {
  const eff = document.getElementById("hitEffect");
  eff.classList.remove("show");
  void eff.offsetWidth;
  eff.classList.add("show");
}

/* „Éê„Éà„É´„Çø„Ç§„Éû„Éº */
let tapCount = 0;
let timeLeft = 5;
const attackBtn = document.getElementById("attackBtn");

attackBtn.addEventListener("click", ()=>{
  tapCount++;
  log("„Åì„ÅÜ„Åí„ÅçÔºÅ");
  showHitEffect();
});

/* „Çà„Éº„ÅÑ‚Ä¶ */
let startCount = 3;
const startInterval = setInterval(()=>{
  attackBtn.textContent = "„Çà„Éº„ÅÑ‚Ä¶ " + startCount;
  startCount--;
  if(startCount < 0){
    clearInterval(startInterval);
    startBattle();
  }
}, 1000);

/* „Éê„Éà„É´ÈñãÂßã */
function startBattle(){
  attackBtn.disabled = false;
  attackBtn.textContent = "„Åì„ÅÜ„Åí„ÅçÔºÅ";

  const timer = setInterval(()=>{
    timeLeft--;
    attackBtn.textContent = `„Åì„ÅÜ„Åí„ÅçÔºÅ (${timeLeft})`;

    if(timeLeft <= 0){
      clearInterval(timer);
      attackBtn.disabled = true;
      finishBattle();
    }
  }, 1000);
}

/* ÁµêÊûúÂà§ÂÆö */
function finishBattle(){

  enemyHP = Math.max(0, 100 - tapCount * 5);
  playerHP = Math.max(0, 100 - Math.floor(Math.random()*15));
  updateHp();

  log(`„ÅÇ„Å™„Åü„ÅÆ„Çø„ÉÉ„Éó„Åô„ÅÜÔºö${tapCount}„Åã„ÅÑ`);

  if (tapCount >= WIN_TAPS) {
    log("„ÅÇ„Å™„Åü„ÅÆ„Åã„Å°ÔºÅÔºÅüéâ");
    showPopup("üéâ „Åã„Å£„Åü„ÇàÔºÅÔºÅ");

    let t = Number(localStorage.getItem("specialTicket") || 0);
    localStorage.setItem("specialTicket", t + 1);

    /* ‚òÖ ÂãùÂà© ‚Üí „Çπ„Éö„Ç∑„É£„É´„Ç¨„ÉÅ„É£„Å∏ÈÅ∑Áßª */
    setTimeout(()=>{
      location.href = "special_gacha.html";
    },1500);

  } else {
    log("„Å≤„Åç„Çè„ÅëÔºÅ „Åæ„Åü„Å°„Çá„ÅÜ„Åõ„Çì„Åó„Çà„ÅÜÔºÅ");
    showPopup("„Å≤„Åç„Çè„ÅëÔºÅ");
  }
}
</script>

</body>
</html>
