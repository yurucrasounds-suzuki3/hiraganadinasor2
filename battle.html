<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒãƒˆãƒ«</title>

<style>
  * { touch-action: manipulation; }

  body {
    background: linear-gradient(#ffe9b3 0%, #fff6e0 40%, #f2d39a 100%);
    font-family: "Kosugi Maru", sans-serif;
    margin: 0;
    padding-top: 20px;
    text-align: center;
    overflow: hidden;
  }

  #backBtn {
    position: fixed; top: 10px; left: 10px;
    background: #4c8f3a; color: white;
    padding: 10px 18px; border-radius: 20px;
    text-decoration: none; z-index: 10;
  }

  .battle-wrapper {
    width: 100%; max-width: 650px; margin: 0 auto;
    position: relative;
  }

  .battle-area {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 90%;
    margin: 10px auto;
  }

  .char { width: 40%; }
  .char img { width: 100%; max-width: 200px; }

  .ground {
    width: 80%; height: 20px;
    background: rgba(0,0,0,0.1);
    border-radius: 50%; margin: 0 auto 5px;
  }

  .hp-bar {
    width: 80%; height: 14px;
    background: #ccc; border-radius: 10px;
    margin: 4px auto 5px;
    overflow: hidden;
  }
  .hp-inner {
    height: 100%; background: #4c8f3a;
    transition: width 0.3s;
  }

  .char-name { font-size: 18px; margin-top: 2px; }

  /* ï¼ï¼ï¼ï¼ï¼ æ”»æ’ƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ï¼ï¼ï¼ï¼ï¼ */
  #hitEffect {
    position: absolute;
    top: 45%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.2);
    font-size: 60px;
    color: #ff3b30;
    font-weight: bold;
    opacity: 0;
    pointer-events: none;
    z-index: 50;
  }

  #hitEffect.show {
    animation: hitAnime 0.3s ease-out;
  }

  @keyframes hitAnime {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.2) rotate(-10deg); }
    40% { opacity: 1; transform: translate(-50%, -50%) scale(1.3) rotate(5deg); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.6) rotate(0deg); }
  }

  /* ï¼ï¼ï¼ï¼ï¼ ãƒœã‚¿ãƒ³ ï¼ï¼ï¼ï¼ï¼ */
  #attackBtn {
    margin-top: 20px;
    padding: 20px 40px;
    background: #ff7f50;
    color: #fff;
    font-size: 28px;
    border: none;
    border-radius: 15px;
  }
  #attackBtn:active { transform: scale(0.95); }

  #log {
    background: #fff; width: 90%; max-width: 360px;
    margin: 20px auto; padding: 15px;
    height: 150px; overflow-y: auto;
    border-radius: 15px;
  }

  #popup {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.6);
    background: white; padding: 25px 35px;
    border-radius: 20px; font-size: 24px;
    opacity: 0; pointer-events: none;
    transition: 0.3s; z-index: 99;
  }
  #popup.show {
    opacity: 1; transform: translate(-50%,-50%) scale(1);
  }
</style>
</head>

<body>

<a id="backBtn" href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸</a>

<h2>ãƒãƒˆãƒ«ï¼</h2>

<div class="battle-wrapper">

  <!-- â˜… æ”»æ’ƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
  <div id="hitEffect">ãƒ“ã‚·ãƒƒï¼ï¼</div>

  <div class="battle-area">

    <div class="char">
      <div class="ground"></div>
      <img id="playerImg">
      <div class="hp-bar"><div id="playerHp" class="hp-inner"></div></div>
      <div id="playerName" class="char-name"></div>
    </div>

    <div class="char">
      <div class="ground"></div>
      <img id="enemyImg">
      <div class="hp-bar"><div id="enemyHp" class="hp-inner"></div></div>
      <div id="enemyName" class="char-name"></div>
    </div>

  </div>
</div>

<button id="attackBtn" disabled>ã‚ˆãƒ¼ã„â€¦</button>

<div id="log"></div>
<div id="popup"></div>

<script>
const WIN_TAPS = 10;

/* è‡ªåˆ†ã®ã‚­ãƒ£ãƒ© */
const playerChar = {
  name: "ãƒ†ã‚£ãƒ©ãƒã‚µã‚¦ãƒ«ã‚¹",
  img: "images/tira.png"
};

/* æ•µã‚­ãƒ£ãƒ© */
const enemyChar = {
  name: "ã‚ã‹ãŠã«",
  img: "images/oni.png"
};

/* è¡¨ç¤º */
document.getElementById("playerImg").src = playerChar.img;
document.getElementById("playerName").textContent = playerChar.name;
document.getElementById("enemyImg").src = enemyChar.img;
document.getElementById("enemyName").textContent = enemyChar.name;

let playerHP = 100;
let enemyHP  = 100;

function updateHp() {
  document.getElementById("playerHp").style.width = playerHP + "%";
  document.getElementById("enemyHp").style.width  = enemyHP + "%";
}
updateHp();

/* æ”»æ’ƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
function showHitEffect() {
  const eff = document.getElementById("hitEffect");
  eff.classList.remove("show");
  void eff.offsetWidth;  // â† ã‚¢ãƒ‹ãƒ¡ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
  eff.classList.add("show");
}

/* ãƒ­ã‚° */
function log(t){
  const box = document.getElementById("log");
  box.innerHTML += t + "<br>";
  box.scrollTop = box.scrollHeight;
}

/* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
function showPopup(t){
  const p = document.getElementById("popup");
  p.textContent = t;
  p.classList.add("show");
  setTimeout(()=>p.classList.remove("show"),1500);
}

/* ãƒãƒˆãƒ«å‡¦ç† */
let tapCount = 0;
let timeLeft = 5;

const attackBtn = document.getElementById("attackBtn");

/* â˜… ã‚¿ãƒƒãƒ—æ”»æ’ƒ */
attackBtn.addEventListener("click", ()=>{
  tapCount++;
  log("ã“ã†ã’ãï¼");
  showHitEffect();   // â† â˜…æ”»æ’ƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆç™ºå‹•â˜…
});

/* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
let startCount = 3;
const startInterval = setInterval(()=>{
  attackBtn.textContent = "ã‚ˆãƒ¼ã„â€¦" + startCount;
  startCount--;

  if(startCount < 0){
    clearInterval(startInterval);
    startBattle();
  }
}, 1000);

/* ãƒãƒˆãƒ«é–‹å§‹ */
function startBattle(){
  attackBtn.disabled = false;
  attackBtn.textContent = "ã“ã†ã’ãï¼ï¼ˆ5ï¼‰";

  const timer = setInterval(()=>{
    timeLeft--;
    attackBtn.textContent = `ã“ã†ã’ãï¼ï¼ˆ${timeLeft}ï¼‰`;

    if(timeLeft <= 0){
      clearInterval(timer);
      attackBtn.disabled = true;
      finishBattle();
    }
  }, 1000);
}

/* çµæœå‡¦ç† */
function finishBattle(){
  enemyHP = Math.max(0, 100 - tapCount * 5);
  updateHp();

  log(`ã‚ãªãŸã®ã‚¿ãƒƒãƒ—ã™ã†ï¼š${tapCount} ã‹ã„`);

  if(tapCount >= WIN_TAPS){
    log("ã‚ãªãŸã®ã‹ã¡ï¼!ï¼ğŸ‰");
    showPopup("ğŸ‰ ã‹ã£ãŸã‚ˆï¼ï¼");

    let t = Number(localStorage.getItem("specialTicket") || 0);
    localStorage.setItem("specialTicket", t + 1);

    setTimeout(()=>{
      location.href = "special_gacha.html";
    }, 1200);

  } else {
    log("ã²ãã‚ã‘ï¼");
    showPopup("ã²ãã‚ã‘ï¼");
  }
}
</script>

</body>
</html>
