<!DOCTYPE html>
<html lang="ja">
<head><script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "ukduq8awzu");
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>„Çå„Çì„Åó„ÇÖ„ÅÜ</title>

<style>
  body {
    text-align: center;
    font-family: "UDDigiKyokasho", "Noto Sans JP", sans-serif;
    background: #fff6e0;
    margin: 0;
    padding: 20px;
    overflow: hidden;
  }

  @font-face {
    font-family: "UDDigiKyokasho";
    src: url("https://fonts.gstatic.com/ea/uddigikyokasho/v1/UDDigiKyokashoN-R.woff2") format("woff2");
  }

  #backBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    background: #4c8f3a;
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    text-decoration: none;
    z-index: 10;
  }

  #progress {
    font-size: 22px;
    color: #4c8f3a;
    margin-top: 10px;
    font-weight: bold;
  }

  #canvas-container {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
  }

  #templateImg {
    position: absolute;
    width: 300px;
    height: 300px;
    object-fit: contain;
    opacity: 0.25;
    pointer-events: none;
    user-select: none;
  }

  #canvas {
    border: 4px solid #4c8f3a;
    background: white;
    border-radius: 20px;
    touch-action: none !important;
  }

  .btn {
    margin-top: 20px;
    padding: 15px 25px;
    background: #4c8f3a;
    color: white;
    border-radius: 10px;
    border: none;
    font-size: 22px;
  }

  #popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.6);
    background: white;
    padding: 25px 35px;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 24px;
    color: #4c8f3a;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    z-index: 50;
  }
  #popup.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
</style>
</head>

<body>

<a id="backBtn" href="hiragana.html">‚Üê „ÇÇ„Å©„Çã</a>

<h2 id="title" style="color:#4c8f3a;"></h2>
<div id="progress"></div>

<div id="canvas-container">
  <img id="templateImg">
  <canvas id="canvas" width="300" height="300"></canvas>
</div>

<button class="btn" onclick="clearCanvas()">„ÇÑ„Çä„Å™„Åä„Åô</button>
<button class="btn" onclick="finishPractice()">„Åß„Åç„ÅüÔºÅ</button>

<div id="popup"></div>

<audio id="okSound" src="https://www.soundjay.com/buttons/sounds/button-09.mp3"></audio>

<script>
/* =====================================================
   „É¢„Éº„Éâ„ÅÆÂà§ÂÆöÔºàÂº∑ÂåñÁâàÔºâ
===================================================== */
let omakaseMode = (localStorage.getItem("omakaseMode") === "true");
let omakaseCount = Number(localStorage.getItem("omakaseCount") || 0);

/* omakaseMode „Åå "off" „Åæ„Åü„ÅØ null „ÅÆÊôÇ ‚Üí ÈÄöÂ∏∏„É¢„Éº„Éâ */
if (localStorage.getItem("omakaseMode") === "off") {
  omakaseMode = false;
}

/* =====================================================
    ÁèæÂú®„ÅÆÊñáÂ≠ó
===================================================== */
let selected = localStorage.getItem("selectedChar") || "„ÅÇ";
document.getElementById("title").textContent = `${selected} „Çí„Å™„Åû„Çç„ÅÜÔºÅ`;

/* =====================================================
    Êõ∏„ÅçÈ†ÜÁîªÂÉèÔºà„Éï„Ç©„É´„ÉÄËá™ÂãïÂà§Âà•Ôºâ
===================================================== */
function getStrokeImagePath(ch) {
  if (/[„ÅÇ-„Çì]/.test(ch)) return `images/stroke/hira/${ch}.png`;
  if (/[„Ç¢-„É≥]/.test(ch)) return `images/stroke/kata/${ch}.png`;
  if (/[0-9]/.test(ch)) return `images/stroke/num/${ch}.png`;
  if (/[A-Z]/.test(ch)) return `images/stroke/roman_upper/${ch}.png`;
  if (/[a-z]/.test(ch)) return `images/stroke/roman_lower/${ch}.png`;
  return `images/stroke/${ch}.png`;
}

document.getElementById("templateImg").src = getStrokeImagePath(selected);

/* =====================================================
    ÈÄ≤ÊçóË°®Á§∫
===================================================== */
function updateProgress() {
  if (omakaseMode) {
    document.getElementById("progress").textContent =
      `„Åä„Åæ„Åã„Åõ„É¢„Éº„ÉâÔºö${omakaseCount} / 10`;
    return;
  }

  let count = Number(localStorage.getItem("practiceCount") || 0);
  const rest = Math.max(0, 5 - count);

  document.getElementById("progress").textContent =
    rest > 0 ? `„Ç¨„ÉÅ„É£„Åæ„ÅßÔºö„ÅÇ„Å® ${rest} „Åã„ÅÑ`
             : `„Ç¨„ÉÅ„É£„Åå„Å≤„Åë„Çã„ÇàÔºÅ`;
}
updateProgress();

/* =====================================================
    ÊèèÁîªÂá¶ÁêÜ
===================================================== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let drawing = false;
let lastX = null;
let lastY = null;
let drawDistance = 0;

canvas.addEventListener("pointerdown", e => {
  drawing = true;
  const rect = canvas.getBoundingClientRect();
  lastX = e.clientX - rect.left;
  lastY = e.clientY - rect.top;
});

canvas.addEventListener("pointerup", () => {
  drawing = false;
  ctx.beginPath();
});

canvas.addEventListener("pointermove", e => {
  if (!drawing) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const dx = x - lastX;
  const dy = y - lastY;
  drawDistance += Math.sqrt(dx * dx + dy * dy);

  ctx.lineWidth = 12;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#4c8f3a";

  ctx.lineTo(x, y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x, y);

  lastX = x;
  lastY = y;
});

/* =====================================================
   Êìç‰ΩúÁ≥ª
===================================================== */
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawDistance = 0;
}

function showPopup(text) {
  const popup = document.getElementById("popup");
  popup.textContent = text;
  popup.classList.add("show");
  setTimeout(() => popup.classList.remove("show"), 1400);
}

/* =====================================================
   „Çå„Çì„Åó„ÇÖ„ÅÜÂ±•Ê≠¥
===================================================== */
function savePracticeHistory() {
  const history = JSON.parse(localStorage.getItem("history") || "{}");

  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, "0");
  const d = String(now.getDate()).padStart(2, "0");
  const key = `${y}-${m}-${d}`;

  if (!history[key]) history[key] = [];
  history[key].push({ char: selected, time: Date.now() });

  localStorage.setItem("history", JSON.stringify(history));
}

/* =====================================================
   „Åä„Åæ„Åã„Åõ ‚Üí Ê¨°„Å∏
===================================================== */
function handleOmakaseNext() {

  omakaseCount++;
  localStorage.setItem("omakaseCount", omakaseCount);

  if (omakaseCount >= 10) {
    localStorage.setItem("omakaseMode", "off");
    localStorage.setItem("omakaseCount", "0");

    showPopup("10„Åã„ÅÑ „Åü„Å£„Åõ„ÅÑÔºÅ„Éê„Éà„É´„Å∏GOÔºÅÔºÅüî•");
    setTimeout(() => location.href = "battle.html", 1200);
    return;
  }

  const chars =
    "„ÅÇ„ÅÑ„ÅÜ„Åà„Åä„Åã„Åç„Åè„Åë„Åì„Åï„Åó„Åô„Åõ„Åù„Åü„Å°„Å§„Å¶„Å®„Å™„Å´„Å¨„Å≠„ÅÆ„ÅØ„Å≤„Åµ„Å∏„Åª„Åæ„Åø„ÇÄ„ÇÅ„ÇÇ„ÇÑ„ÇÜ„Çà„Çâ„Çä„Çã„Çå„Çç„Çè„Çí„Çì" +
    "„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥" +
    "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";

  const nextChar = chars[Math.floor(Math.random() * chars.length)];
  localStorage.setItem("selectedChar", nextChar);

  showPopup(`${selected} „Åß„Åç„ÅüÔºÅ„Å§„Åé„ÅØ„Äå${nextChar}„ÄçÔºÅ`);
  setTimeout(() => location.href = "practice.html", 1200);
}

/* =====================================================
   ÈÄöÂ∏∏Á∑¥Áøí ‚Üí „Åß„Åç„ÅüÔºÅ
===================================================== */
function finishPractice() {

  document.getElementById("okSound").play();

  if (drawDistance < 150) {
    showPopup("„Åæ„Åö„ÅØÊõ∏„ÅÑ„Å¶„Åø„Çà„ÅÜÔºÅ‚úèÔ∏è");
    return;
  }

  savePracticeHistory();

  /* ‚ñº „Åä„Åæ„Åã„Åõ„É¢„Éº„Éâ */
  if (omakaseMode) {
    handleOmakaseNext();
    return;
  }

  /* ‚ñº ÈÄöÂ∏∏„É¢„Éº„Éâ */
  let count = Number(localStorage.getItem("practiceCount") || 0);
  count = Math.min(count + 1, 5);
  localStorage.setItem("practiceCount", count);

  updateProgress();

  if (count < 5) {
    showPopup(`„Åô„Åî„ÅÑÔºÅü¶ñ „Ç¨„ÉÅ„É£„Åæ„Åß „ÅÇ„Å® ${5 - count} „Åã„ÅÑÔºÅ`);
    clearCanvas();
    return;
  }
  
  showPopup("5„Åã„ÅÑ „Åü„Å£„Åõ„ÅÑÔºÅ„Ç¨„ÉÅ„É£„Å†ÔºÅÔºÅüéâü¶ñ");
  setTimeout(() => location.href = "gacha.html", 1200);
}
</script>

</body>
</html>
