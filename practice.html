<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>„Çå„Çì„Åó„ÇÖ„ÅÜ</title>

<style>
  body {
    text-align: center;
    font-family: "UDDigiKyokasho", "Noto Sans JP", sans-serif;
    background: #fff6e0;
    margin: 0;
    padding: 20px;
    overflow: hidden;
  }

  @font-face {
    font-family: "UDDigiKyokasho";
    src: url("https://fonts.gstatic.com/ea/uddigikyokasho/v1/UDDigiKyokashoN-R.woff2") format("woff2");
  }

  #backBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    background: #4c8f3a;
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    text-decoration: none;
    z-index: 10;
    touch-action: auto;
  }

  #progress {
    font-size: 22px;
    color: #4c8f3a;
    margin-top: 10px;
    font-weight: bold;
  }

  #canvas-container {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
  }

  #templateImg {
    position: absolute;
    width: 300px;
    height: 300px;
    object-fit: contain;
    opacity: 0.25;
    pointer-events: none;
    user-select: none;
  }

  #canvas {
    border: 4px solid #4c8f3a;
    background: white;
    border-radius: 20px;
    touch-action: none !important;
  }

  .btn {
    margin-top: 20px;
    padding: 15px 25px;
    background: #4c8f3a;
    color: white;
    border-radius: 10px;
    border: none;
    font-size: 22px;
    touch-action: auto !important;
  }

  #popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.6);
    background: white;
    padding: 25px 35px;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 24px;
    color: #4c8f3a;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    z-index: 50;
  }

  #popup.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
</style>
</head>

<body>

<a id="backBtn" href="hiragana.html">‚Üê „ÇÇ„Å©„Çã</a>

<h2 id="title" style="color:#4c8f3a;"></h2>
<div id="progress"></div>

<div id="canvas-container">
  <img id="templateImg">
  <canvas id="canvas" width="300" height="300"></canvas>
</div>

<button class="btn" onclick="clearCanvas()">„ÇÑ„Çä„Å™„Åä„Åô</button>
<button class="btn" onclick="finishPractice()">„Åß„Åç„ÅüÔºÅ</button>

<div id="popup"></div>

<audio id="okSound" src="https://www.soundjay.com/buttons/sounds/button-09.mp3"></audio>

<script>
/* ---------------------------
    ÂàùÊúüË®≠ÂÆö
---------------------------- */
const selected = localStorage.getItem("selectedChar") || "„ÅÇ";
document.getElementById("title").textContent = `${selected} „Çí„Å™„Åû„Çç„ÅÜÔºÅ`;
document.getElementById("templateImg").src = `images/stroke/${selected}.png`;

function updateProgress() {
  let count = Number(localStorage.getItem("practiceCount") || 0);
  document.getElementById("progress").textContent =
    `„Ç¨„ÉÅ„É£„Åæ„ÅßÔºö„ÅÇ„Å® ${10 - count} Âõû`;
}
updateProgress();

/* ---------------------------
    ÊèèÁîªÁ≥ª
---------------------------- */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let drawing = false;
let lastX = null;
let lastY = null;
let drawDistance = 0;  // ‚Üê Á∑ö„ÅÆÈï∑„Åï„ÇíË®òÈå≤

canvas.addEventListener("pointerdown", e => {
  drawing = true;
  const rect = canvas.getBoundingClientRect();
  lastX = e.clientX - rect.left;
  lastY = e.clientY - rect.top;
});

canvas.addEventListener("pointerup", () => {
  drawing = false;
  ctx.beginPath();
});

canvas.addEventListener("pointermove", e => {
  if (!drawing) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  // Á∑ö„ÅÆË∑ùÈõ¢„ÇíÂä†ÁÆó
  const dx = x - lastX;
  const dy = y - lastY;
  drawDistance += Math.sqrt(dx*dx + dy*dy);   // ‚Üê Ë∑ùÈõ¢„Å®„Åó„Å¶ËøΩÂä†

  ctx.lineWidth = 12;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#4c8f3a";

  ctx.lineTo(x, y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x, y);

  lastX = x;
  lastY = y;
});

/* ---------------------------
   „Ç≠„É£„É≥„Éê„ÇπÊ∂àÂéª
---------------------------- */
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawDistance = 0;
}

/* ---------------------------
   „Éù„ÉÉ„ÉóÊºîÂá∫
---------------------------- */
function showPopup(text) {
  const popup = document.getElementById("popup");
  popup.textContent = text;
  popup.classList.add("show");
  setTimeout(() => popup.classList.remove("show"), 1400);
}

/* ---------------------------
   „Åß„Åç„ÅüÔºÅÂá¶ÁêÜ
---------------------------- */
function finishPractice() {
  document.getElementById("okSound").play();

  console.log("distance =", drawDistance);

  /* ‚ñº Êõ∏„ÅÑ„Åü„Åã„Å©„ÅÜ„ÅãÂà§ÂÆöÔºàË∑ùÈõ¢„Åå‰∏ÄÂÆö‰ª•‰∏ã„Å™„ÇâNGÔºâ */
  if (drawDistance < 150) {   // ‚Üê Ë∂ÖÁîò„ÅÑÂà§ÂÆöÔºàÂ≠ê„Å©„ÇÇÂêë„ÅëÔºâ
    showPopup("„Åæ„Åö„ÅØÊõ∏„ÅÑ„Å¶„Åø„Çà„ÅÜÔºÅ‚úèÔ∏è");
    return;
  }

  /* ‚ñº Á∑¥Áøí„Ç´„Ç¶„É≥„Éà */
  let count = Number(localStorage.getItem("practiceCount") || 0);
  count++;
  localStorage.setItem("practiceCount", count);

  updateProgress();

  /* ‚ñº Êú™ÈÅîÊàê„Å™„ÇâÊ¨°„Å∏ */
  if (count < 10) {
    showPopup(`„Åô„Åî„ÅÑÔºÅü¶ñ „Ç¨„ÉÅ„É£„Åæ„Åß „ÅÇ„Å® ${10 - count} ÂõûÔºÅ`);
    clearCanvas();
    return;
  }

  /* ‚ñº 10ÂõûÈÅîÊàê */
  localStorage.setItem("practiceCount", 10);
  showPopup("10ÂõûÈÅîÊàêÔºÅ„Ç¨„ÉÅ„É£„Å†ÔºÅÔºÅüéâü¶ñ");

  setTimeout(() => {
    location.href = "gacha.html";
  }, 1200);
}
</script>

</body>
</html>
