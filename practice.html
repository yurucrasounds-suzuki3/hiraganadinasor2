<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚Œã‚“ã—ã‚…ã†</title>

<style>
  body {
    text-align: center;
    font-family: "UDDigiKyokasho", "Noto Sans JP", sans-serif;
    background: #fff6e0;
    margin: 0;
    padding: 20px;
    overflow: hidden;
  }

  @font-face {
    font-family: "UDDigiKyokasho";
    src: url("https://fonts.gstatic.com/ea/uddigikyokasho/v1/UDDigiKyokashoN-R.woff2") format("woff2");
  }

  #backBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    background: #4c8f3a;
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    text-decoration: none;
    z-index: 10;
    touch-action: auto;
  }

  #progress {
    font-size: 22px;
    color: #4c8f3a;
    margin-top: 10px;
    font-weight: bold;
  }

  #canvas-container {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
  }

  #templateImg {
    position: absolute;
    width: 300px;
    height: 300px;
    object-fit: contain;
    opacity: 0.25;
    pointer-events: none;
    user-select: none;
  }

  #canvas {
    border: 4px solid #4c8f3a;
    background: white;
    border-radius: 20px;
    touch-action: none !important;
  }

  .btn {
    margin-top: 20px;
    padding: 15px 25px;
    background: #4c8f3a;
    color: white;
    border-radius: 10px;
    border: none;
    font-size: 22px;
    touch-action: auto !important;
  }

  #popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.6);
    background: white;
    padding: 25px 35px;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 24px;
    color: #4c8f3a;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    z-index: 50;
  }

  #popup.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
</style>
</head>

<body>

<a id="backBtn" href="hiragana.html">â† ã‚‚ã©ã‚‹</a>

<h2 id="title" style="color:#4c8f3a;"></h2>
<div id="progress"></div>

<div id="canvas-container">
  <img id="templateImg">
  <canvas id="canvas" width="300" height="300"></canvas>
</div>

<button class="btn" onclick="clearCanvas()">ã‚„ã‚ŠãªãŠã™</button>
<button class="btn" onclick="finishPractice()">ã§ããŸï¼</button>

<div id="popup"></div>

<audio id="okSound" src="https://www.soundjay.com/buttons/sounds/button-09.mp3"></audio>

<script>
/* ---------------------------
    åˆæœŸè¨­å®š
---------------------------- */
const selected = localStorage.getItem("selectedChar") || "ã‚";
document.getElementById("title").textContent = `${selected} ã‚’ãªãã‚ã†ï¼`;
document.getElementById("templateImg").src = `images/stroke/${selected}.png`;

function updateProgress() {
  let count = Number(localStorage.getItem("practiceCount") || 0);
  const rest = Math.max(0, 10 - count);
  document.getElementById("progress").textContent =
    rest > 0 ? `ã‚¬ãƒãƒ£ã¾ã§ï¼šã‚ã¨ ${rest} ã‹ã„` : `ã‚¬ãƒãƒ£ãŒã²ã‘ã‚‹ã‚ˆï¼`;
}
updateProgress();

/* ---------------------------
    æç”»ç³»
---------------------------- */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let drawing = false;
let lastX = null;
let lastY = null;
let drawDistance = 0;  // â† ç·šã®é•·ã•ã‚’è¨˜éŒ²

canvas.addEventListener("pointerdown", e => {
  drawing = true;
  const rect = canvas.getBoundingClientRect();
  lastX = e.clientX - rect.left;
  lastY = e.clientY - rect.top;
});

canvas.addEventListener("pointerup", () => {
  drawing = false;
  ctx.beginPath();
});

canvas.addEventListener("pointermove", e => {
  if (!drawing) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  // ç·šã®è·é›¢ã‚’åŠ ç®—
  const dx = x - lastX;
  const dy = y - lastY;
  drawDistance += Math.sqrt(dx*dx + dy*dy);

  ctx.lineWidth = 12;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#4c8f3a";

  ctx.lineTo(x, y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x, y);

  lastX = x;
  lastY = y;
});

/* ---------------------------
   ã‚­ãƒ£ãƒ³ãƒã‚¹æ¶ˆå»
---------------------------- */
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawDistance = 0;
}

/* ---------------------------
   ãƒãƒƒãƒ—æ¼”å‡º
---------------------------- */
function showPopup(text) {
  const popup = document.getElementById("popup");
  popup.textContent = text;
  popup.classList.add("show");
  setTimeout(() => popup.classList.remove("show"), 1400);
}

/* ---------------------------
   ä»Šæ—¥ã®ã‚Œã‚“ã—ã‚…ã†ã‚’ history ã«è¨˜éŒ²
   ï¼ˆã‚Œã‚“ã—ã‚…ã†ãã‚ãç”»é¢ãŒèª­ã‚€ãƒ‡ãƒ¼ã‚¿ï¼‰
---------------------------- */
function savePracticeHistory() {
  // æ—¢å­˜ã® history ã‚’å–å¾—
  const history = JSON.parse(localStorage.getItem("history") || "{}");

  // ä»Šæ—¥ã®ã‚­ãƒ¼ï¼ˆYYYY-MM-DDï¼‰
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, "0");
  const d = String(now.getDate()).padStart(2, "0");
  const key = `${y}-${m}-${d}`;

  // ãã®æ—¥ãŒåˆã‚ã¦ãªã‚‰é…åˆ—ã‚’ä½œã‚‹
  if (!history[key]) history[key] = [];

  // 1ã‹ã„åˆ†ã‚’è¿½åŠ ï¼ˆä¸­èº«ã¯ãªã‚“ã§ã‚‚OKã€‚ã“ã“ã§ã¯æ–‡å­—æƒ…å ±ã‚‚ä¿å­˜ï¼‰
  history[key].push({
    char: selected,
    time: Date.now()
  });

  // ä¿å­˜
  localStorage.setItem("history", JSON.stringify(history));
}

/* ---------------------------
   ã§ããŸï¼å‡¦ç†
---------------------------- */
function finishPractice() {
  document.getElementById("okSound").play();

  console.log("distance =", drawDistance);

  // ã‚ã¾ã‚Šæ›¸ã„ã¦ã„ãªã‹ã£ãŸã‚‰å¼¾ã
  if (drawDistance < 150) {
    showPopup("ã¾ãšã¯æ›¸ã„ã¦ã¿ã‚ˆã†ï¼âœï¸");
    return;
  }

  // â–¼ ç·´ç¿’å›æ•°ã‚«ã‚¦ãƒ³ãƒˆï¼ˆã‚¬ãƒãƒ£ç”¨ï¼‰
  let count = Number(localStorage.getItem("practiceCount") || 0);
  count++;
  if (count > 10) count = 10;   // ä¸Šé™10ã‹ã„
  localStorage.setItem("practiceCount", count);

  // â–¼ ä»Šæ—¥ã®ã‚Œã‚“ã—ã‚…ã†å±¥æ­´ã‚’ä¿å­˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ï¼‰
  savePracticeHistory();

  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºæ›´æ–°
  updateProgress();

  // ã¾ã 10ã‹ã„æœªæº€
  if (count < 10) {
    showPopup(`ã™ã”ã„ï¼ğŸ¦– ã‚¬ãƒãƒ£ã¾ã§ ã‚ã¨ ${10 - count} ã‹ã„ï¼`);
    clearCanvas();
    return;
  }

  // 10ã‹ã„é”æˆ
  showPopup("10ã‹ã„ ãŸã£ã›ã„ï¼ã‚¬ãƒãƒ£ã ï¼ï¼ğŸ‰ğŸ¦–");

  setTimeout(() => {
    location.href = "gacha.html";
  }, 1200);
}
</script>

</body>
</html>
